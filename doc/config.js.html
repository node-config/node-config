<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns:yui="http://yuilibrary.com/rdf/1.0/yui.rdf#">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<title>config   config.js </title>

	<link rel="stylesheet" type="text/css" href="assets/reset-fonts-grids-min.css?stamp=1382629024.25" />
	<link rel="stylesheet" type="text/css" href="assets/api.css?stamp=1382629024.25" />

    <script type="text/javascript" src="assets/api-js?stamp=1382629024.25"></script>
    <script type="text/javascript" src="assets/ac-js?stamp=1382629024.25"></script>
</head>

<body id="node-monitor">

<div id="doc3" class="yui-t2">
	<div id="hd">
        <h1><a href="https://github.com/lorenwest/node-config" title="Node.js Configuration">Node.js Configuration</a></h1>
        <a href="./index.html" title="Node.js Configuration">Node.js Configuration</a>
            &gt; <a href="./module_config.html" title="config">config</a>
                
                 &gt; config.js (source view) 
        <form onsubmit="return false">
            <div id="propertysearch">
                Search: <input autocomplete="off" id="searchinput" />
                <div id="searchresults">
                    &nbsp;
                </div>
            </div>
        </form>
	</div>

	<div id="bd">
		<div id="yui-main">
			<div class="yui-b">
            <form action="#" name="yui-classopts-form" method="get" id="yui-classopts-form">
                <fieldset>
                    <legend>Filters</legend>
                <span class="classopts" style="display:none;"><input type="checkbox" name="show_private" id="show_private" /> <label for="show_private">Show Private</label></span>
                <span id="showProtected" class="classopts" style="display:none'"><input type="checkbox" name="show_protected" id="show_protected" /> <label for="show_protected">Show Protected</label></span>
                <span class="classopts" style="display:none;"><input type="checkbox" name="show_deprecated" id="show_deprecated" /> <label for="show_deprecated">Show Deprecated</label></span>
                </fieldset>
            </form>

                    <div id="srcout">
                        <style>
                            #doc3 .classopts { display:none; }
                        </style>
<div class="highlight"><pre><span class="cm">/*jsl:declare global */</span>
<span class="c1">// config.js (c) 2010-2013 Loren West and other contributors</span>
<span class="c1">// May be freely distributed under the MIT license.</span>
<span class="c1">// For further details and documentation:</span>
<span class="c1">// http://lorenwest.github.com/node-config</span>

<span class="c1">// Dependencies</span>
<span class="kd">var</span> <span class="nx">Yaml</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// External libraries are lazy-loaded</span>
    <span class="nx">VisionmediaYaml</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>  <span class="c1">// only if these file types exist.</span>
    <span class="nx">Coffee</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">FileSystem</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="c1">// Static members</span>
<span class="kd">var</span> <span class="nx">DEFAULT_CLONE_DEPTH</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="nx">FILE_WATCHER_INTERVAL</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">,</span> <span class="c1">// For old style (pre-6.0) file watching</span>
    <span class="nx">CONFIG_DIR</span><span class="p">,</span> <span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="nx">NODE_ENV</span><span class="p">,</span> <span class="nx">APP_INSTANCE</span><span class="p">,</span>
    <span class="nx">DISABLE_FILE_WATCH</span><span class="p">,</span> <span class="nx">PERSIST_ON_CHANGE</span><span class="p">,</span> <span class="nx">HOST</span><span class="p">,</span> <span class="nx">HOSTNAME</span><span class="p">,</span>
    <span class="nx">originalConfig</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>       <span class="c1">// Not including the runtime.json values</span>
    <span class="nx">runtimeJson</span> <span class="o">=</span> <span class="p">{},</span>            <span class="c1">// Current runtimeJson extensions</span>
    <span class="nx">runtimeJsonWatcher</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>   <span class="c1">// Filesystem watcher for runtime.json</span>
    <span class="nx">configSources</span> <span class="o">=</span> <span class="p">[],</span>          <span class="c1">// Configuration sources - array of {name, original, parsed}</span>
    <span class="nx">isQueuedForPersistence</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Runtime Application Configurations&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The config module exports a singleton object representing all runtime</span>
<span class="cm"> * configurations for this application deployment.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Application configurations are stored in files within the config directory</span>
<span class="cm"> * of your application.  The default configuration file is loaded, followed</span>
<span class="cm"> * by files specific to the deployment type (development, testing, staging,</span>
<span class="cm"> * production, etc.).</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * For example, with the following config/default.yaml file:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   ...</span>
<span class="cm"> *   customer:</span>
<span class="cm"> *     &amp;nbsp;&amp;nbsp;initialCredit: 500</span>
<span class="cm"> *     &amp;nbsp;&amp;nbsp;db:</span>
<span class="cm"> *       &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;name: customer</span>
<span class="cm"> *       &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;port: 5984</span>
<span class="cm"> *   ...</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The following code loads the customer section into the CONFIG variable:</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var CONFIG = require(&#39;config&#39;).customer;</span>
<span class="cm"> *   ...</span>
<span class="cm"> *   newCustomer.creditLimit = CONFIG.initialCredit;</span>
<span class="cm"> *   database.open(CONFIG.db.name, CONFIG.db.port);</span>
<span class="cm"> *   ...</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @module config</span>
<span class="cm"> * @class Config</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Get the configuration object.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The configuration object is a shared singleton object within the applicaiton,</span>
<span class="cm"> * attained by calling require(&#39;config&#39;).</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Usually you&#39;ll specify a CONFIG variable at the top of your .js file</span>
<span class="cm"> * for file/module scope. If you want the root of the object, you can do this:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> * var CONFIG = require(&#39;config&#39;);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Sometimes you only care about a specific sub-object within the CONFIG</span>
<span class="cm"> * object.  In that case you could do this at the top of your file:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> * var CONFIG = require(&#39;config&#39;).customer;</span>
<span class="cm"> * or</span>
<span class="cm"> * var CUSTOMER_CONFIG = require(&#39;config&#39;).customer;</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="cm"> *   document.getElementById(&quot;showProtected&quot;).style.display = &quot;block&quot;;</span>
<span class="cm"> * &lt;/script&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method constructor</span>
<span class="cm"> * @return CONFIG {object} - The top level configuration object</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">Config</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="c1">// Initialize parameters from command line, environment, or default</span>
  <span class="nx">NODE_ENV</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;NODE_ENV&#39;</span><span class="p">,</span> <span class="s1">&#39;development&#39;</span><span class="p">);</span>
  <span class="nx">CONFIG_DIR</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;NODE_CONFIG_DIR&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/config&#39;</span><span class="p">);</span>
  <span class="nx">RUNTIME_JSON_FILENAME</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;NODE_CONFIG_RUNTIME_JSON&#39;</span><span class="p">,</span> <span class="nx">CONFIG_DIR</span> <span class="o">+</span> <span class="s1">&#39;/runtime.json&#39;</span><span class="p">);</span>
  <span class="nx">DISABLE_FILE_WATCH</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;NODE_CONFIG_DISABLE_FILE_WATCH&#39;</span><span class="p">);</span>
  <span class="nx">PERSIST_ON_CHANGE</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;NODE_CONFIG_PERSIST_ON_CHANGE&#39;</span><span class="p">);</span>
  <span class="nx">APP_INSTANCE</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;NODE_APP_INSTANCE&#39;</span><span class="p">);</span>
  <span class="nx">HOST</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;HOST&#39;</span><span class="p">);</span>
  <span class="nx">HOSTNAME</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_initParam</span><span class="p">(</span><span class="s1">&#39;HOSTNAME&#39;</span><span class="p">);</span>

  <span class="nx">t</span><span class="p">.</span><span class="nx">_loadFileConfigs</span><span class="p">();</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">_persistConfigsOnChange</span><span class="p">();</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Monitor a configuration value for runtime changes.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Configuration values can be changed at runtime by the application or by a</span>
<span class="cm"> * manual change to the config/runtime.json  file.</span>
<span class="cm"> * This method lets you specify a function to run when a configuration</span>
<span class="cm"> * value changes.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;i&gt;</span>
<span class="cm"> * This was built for monitoring changes to configuration values,</span>
<span class="cm"> * but it can be used for watching changes to &lt;u&gt;any&lt;/u&gt; javascript object.</span>
<span class="cm"> * &lt;/i&gt;&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;Example:&lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var CONFIG = require(&#39;config&#39;).customer;</span>
<span class="cm"> *   ...</span>
<span class="cm"> *</span>
<span class="cm"> *   // Watch for any changes to the customer configuration</span>
<span class="cm"> *   CONFIG.watch(CONFIG, null, function(object, propertyName, priorValue, newValue) {</span>
<span class="cm"> *   &amp;nbsp;console.log(&quot;Customer configuration &quot; + propertyName + &quot; changed from &quot; + priorValue + &quot; to &quot; + newValue);</span>
<span class="cm"> *   });</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method watch</span>
<span class="cm"> * @param object {object} - The object to watch.</span>
<span class="cm"> * @param property {string} - The property name to watch.  Watch all object properties if null.</span>
<span class="cm"> * @param handler {function(object, propertyName, priorValue, newValue)} - Handler called when a property change is detected.</span>
<span class="cm"> *   The handler is run along with other handlers registered for notification.</span>
<span class="cm"> *   If your handler changes the value of the property, that change is applied after all handlers have finished processing the current change.</span>
<span class="cm"> *   Then all handlers (including this one) will be called again with the newly changed value.</span>
<span class="cm"> * @param depth {integer} (optional) - If watching all object properties or if the specified property is an object, this specifies the depth of the object graph to watch for changes.  Default 6.</span>
<span class="cm"> * @return object {object} - The original object is returned - for chaining.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">watch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Initialize</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">allProperties</span> <span class="o">=</span> <span class="nx">property</span> <span class="o">?</span> <span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>

  <span class="c1">// Depth detection</span>
  <span class="nx">depth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">DEFAULT_CLONE_DEPTH</span> <span class="o">:</span> <span class="nx">depth</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Create hidden properties on the object</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">__watchers</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">makeHidden</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;__watchers&#39;</span><span class="p">,</span> <span class="p">{});</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">)</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">makeHidden</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;__propertyValues&#39;</span><span class="p">,</span> <span class="p">{});</span>

  <span class="c1">// Attach watchers to all requested properties</span>
  <span class="nx">allProperties</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">prop</span><span class="p">){</span>

    <span class="c1">// Setup the property for watching (first time only)</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Don&#39;t error re-defining the property if immutable</span>
      <span class="kd">var</span> <span class="nx">descriptor</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">prop</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">descriptor</span> <span class="o">&amp;&amp;</span> <span class="nx">descriptor</span><span class="p">.</span><span class="nx">writable</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

      <span class="c1">// Copy the value to the hidden field, and add the property to watchers</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">o</span><span class="p">[</span><span class="nx">prop</span><span class="p">]];</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">__watchers</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="c1">// Attach the property watcher</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">enumerable</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

        <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
          <span class="c1">// If more than 1 item is in the values array,</span>
          <span class="c1">// then we&#39;re currently processing watchers.</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1">// Current value</span>
            <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
          <span class="k">else</span>
            <span class="c1">// [0] is prior value, [1] is new value being processed</span>
            <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">},</span>

        <span class="nx">set</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">// Return early if no change</span>
          <span class="kd">var</span> <span class="nx">origValue</span> <span class="o">=</span> <span class="nx">o</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_equalsDeep</span><span class="p">(</span><span class="nx">origValue</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">))</span>
            <span class="k">return</span><span class="p">;</span>

          <span class="c1">// Remember the new value, and return if we&#39;re in another setter</span>
          <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">newValue</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

          <span class="c1">// Call all watchers for each change requested</span>
          <span class="kd">var</span> <span class="nx">numIterations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">while</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Detect recursion</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">numIterations</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">origValue</span><span class="p">];</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Recursion detected while setting [&#39;</span> <span class="o">+</span> <span class="nx">prop</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="c1">// Call each watcher for the current values</span>
            <span class="kd">var</span> <span class="nx">oldValue</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">newValue</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
            <span class="nx">o</span><span class="p">.</span><span class="nx">__watchers</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">watcher</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">try</span> <span class="p">{</span>
                <span class="nx">watcher</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">);</span>
              <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Log an error and continue with subsequent watchers</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Exception in object watcher for &quot;</span> <span class="o">+</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">});</span>

            <span class="c1">// Done processing this value</span>
            <span class="nx">o</span><span class="p">.</span><span class="nx">__propertyValues</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>

    <span class="p">}</span> <span class="c1">// Done setting up the property for watching (first time)</span>

    <span class="c1">// Add the watcher to the property</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">__watchers</span><span class="p">[</span><span class="nx">prop</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>

    <span class="c1">// Recurs if this is an object...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">});</span> <span class="c1">// Done processing each property</span>

  <span class="c1">// Return the original object - for chaining</span>
  <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Set default configurations for a node.js module.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This allows module developers to attach their configurations onto the</span>
<span class="cm"> * default configuration object so they can be configured by the consumers</span>
<span class="cm"> * of the module.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;Using the function within your module:&lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var CONFIG = require(&quot;config&quot;);</span>
<span class="cm"> *   CONFIG.setModuleDefaults(&quot;MyModule&quot;, {</span>
<span class="cm"> *   &amp;nbsp;&amp;nbsp;templateName: &quot;t-50&quot;,</span>
<span class="cm"> *   &amp;nbsp;&amp;nbsp;colorScheme: &quot;green&quot;</span>
<span class="cm"> *   });</span>
<span class="cm"> * &lt;br&gt;</span>
<span class="cm"> *   // Template name may be overridden by application config files</span>
<span class="cm"> *   console.log(&quot;Template: &quot; + CONFIG.MyModule.templateName);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The above example results in a &quot;MyModule&quot; element of the configuration</span>
<span class="cm"> * object, containing an object with the specified default values.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method setModuleDefaults</span>
<span class="cm"> * @param moduleName {string} - Name of your module.</span>
<span class="cm"> * @param defaultProperties {object} - The default module configuration.</span>
<span class="cm"> * @return moduleConfig {object} - The module level configuration object.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setModuleDefaults</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="nx">defaultProperties</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Copy the properties into a new object</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">moduleConfig</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">({},</span> <span class="nx">defaultProperties</span><span class="p">);</span>

  <span class="c1">// Set module defaults into the first sources element</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">configSources</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">configSources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span> <span class="o">!==</span> <span class="s1">&#39;Module Defaults&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">configSources</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Module Defaults&#39;</span><span class="p">,</span>
      <span class="nx">parsed</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">configSources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parsed</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">configSources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parsed</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">],</span> <span class="nx">defaultProperties</span><span class="p">);</span>

  <span class="c1">// Attach handlers &amp; watchers onto the module config object</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">_attachProtoDeep</span><span class="p">(</span><span class="nx">moduleConfig</span><span class="p">);</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">_persistConfigsOnChange</span><span class="p">(</span><span class="nx">moduleConfig</span><span class="p">);</span>

  <span class="c1">// Extend the module config object with values from originalConfig</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">originalConfig</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">moduleConfig</span><span class="p">,</span> <span class="nx">originalConfig</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// Save the mixed module config as the original</span>
  <span class="nx">originalConfig</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_cloneDeep</span><span class="p">(</span><span class="nx">moduleConfig</span><span class="p">);</span>

  <span class="c1">// Extend the module config object with values from runtimeJson</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">runtimeJson</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">moduleConfig</span><span class="p">,</span> <span class="nx">runtimeJson</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// Attach the object onto the CONFIG object</span>
  <span class="nx">t</span><span class="p">[</span><span class="nx">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">moduleConfig</span><span class="p">;</span>

  <span class="c1">// Return the module config</span>
  <span class="k">return</span> <span class="nx">moduleConfig</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Make a configuration property hidden so it doesn&#39;t appear when enumerating</span>
<span class="cm"> * elements of the object.&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The property still exists and can be read from and written to, but it won&#39;t</span>
<span class="cm"> * show up in for ... in loops, Object.keys(), or JSON.stringify() type methods.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * If the property already exists, it will be made hidden.  Otherwise it will</span>
<span class="cm"> * be created as a hidden property with the specified value.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;&lt;i&gt;</span>
<span class="cm"> * This method was built for hiding configuration values, but it can be applied</span>
<span class="cm"> * to &lt;u&gt;any&lt;/u&gt; javascript object.</span>
<span class="cm"> * &lt;/i&gt;&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;Example:&lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var CONFIG = require(&#39;config&#39;);</span>
<span class="cm"> *   ...</span>
<span class="cm"> *</span>
<span class="cm"> *   // Hide the Amazon S3 credentials</span>
<span class="cm"> *   CONFIG.makeHidden(CONFIG.amazonS3, &#39;access_id&#39;);</span>
<span class="cm"> *   CONFIG.makeHidden(CONFIG.amazonS3, &#39;secret_key&#39;);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method makeHidden</span>
<span class="cm"> * @param object {object} - The object to make a hidden property into.</span>
<span class="cm"> * @param property {string} - The name of the property to make hidden.</span>
<span class="cm"> * @param value {mixed} - (optional) Set the property value to this (otherwise leave alone)</span>
<span class="cm"> * @return object {object} - The original object is returned - for chaining.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeHidden</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Use the existing value if the new value isn&#39;t specified</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>

  <span class="c1">// Create the hidden property</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
    <span class="nx">enumerable</span> <span class="o">:</span> <span class="kc">false</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Make a configuration property immutable (assuring it cannot be changed</span>
<span class="cm"> * from the current value).&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This operation cannot be un-done.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * &lt;p&gt;&lt;i&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This method was built for disabling runtime changes to configuration values,</span>
<span class="cm"> * but it can be applied to &lt;u&gt;any&lt;/u&gt; javascript object.</span>
<span class="cm"> * &lt;/i&gt;&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;Example:&lt;/p&gt;</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var CONFIG = require(&#39;config&#39;).customer;</span>
<span class="cm"> *   ...</span>
<span class="cm"> *</span>
<span class="cm"> *   // Obtain a DB connection using CONFIG parameters</span>
<span class="cm"> *   database.open(CONFIG.db.name, CONFIG.db.port);</span>
<span class="cm"> *   ...</span>
<span class="cm"> *</span>
<span class="cm"> *   // Don&#39;t allow database changes after connect</span>
<span class="cm"> *   CONFIG.makeImmutable(CONFIG.db, &#39;name&#39;);</span>
<span class="cm"> *   CONFIG.makeImmutable(CONFIG.db, &#39;port&#39;);</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method makeImmutable</span>
<span class="cm"> * @param object {object} - The object to attach an immutable property into.</span>
<span class="cm"> * @param property {string} - The name of the property to make immutable.</span>
<span class="cm"> * @param value {mixed} - (optional) Set the property value to this (otherwise leave alone)</span>
<span class="cm"> * @return object {object} - The original object is returned - for chaining.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeImmutable</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Use the existing value if a new value isn&#39;t specified</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>

  <span class="c1">// Disable writing, and make sure the property cannot be re-configured.</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">property</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">:</span> <span class="nx">value</span><span class="p">,</span>
    <span class="nx">writable</span> <span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">configurable</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Start or stop runtime.json configuration file watching</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Node-config automatically monitors and apply changes made to the</span>
<span class="cm"> * config/runtime.json file.  This paradigm allows for manual changes to running</span>
<span class="cm"> * application servers, and for multi-node application servers to keep in sync.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method allows you to change the polling interval from the default</span>
<span class="cm"> * interval (2.5 seconds), or to turn file watching off.  On Linux systems with</span>
<span class="cm"> * inotify, and in node.js versions 0.6 and above, this interval is ignored.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * runtime.json file watching can be disabled by setting the NODE_CONFIG_DISABLE_FILE_WATCH</span>
<span class="cm"> * environment variable or --NODE_CONFIG_DISABLE_FILE_WATCH command line parameter</span>
<span class="cm"> * to &quot;Y&quot; prior to running your application.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method watchForConfigFileChanges</span>
<span class="cm"> * @param interval {Integer} - Polling interval in milliseconds.  Defaults to 2500.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">watchForConfigFileChanges</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">interval</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Turn off any prior watching</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">watchInterval</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">interval</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">FILE_WATCHER_INTERVAL</span> <span class="o">:</span> <span class="nx">interval</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">FileSystem</span><span class="p">.</span><span class="nx">watch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">runtimeJsonWatcher</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">runtimeJsonWatcher</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="nx">runtimeJsonWatcher</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">unwatchFile</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// If interval is zero or file watching is disabled, don&#39;t attach a new watcher</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">interval</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">DISABLE_FILE_WATCH</span> <span class="o">===</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Re-merge the runtime JSON file if we notice a change</span>
  <span class="kd">var</span> <span class="nx">onFileChange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">retry</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fileContent</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Not much to do on error</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error loading &quot;</span> <span class="o">+</span> <span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Parse the file and mix it in to this config object.</span>
      <span class="c1">// This notifies listeners</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">configObject</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_stripComments</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">));</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">configObject</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error parsing &quot;</span> <span class="o">+</span> <span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="c1">// Retry once - could be someone else writing</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">retry</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">onFileChange</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
          <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="c1">// Use the latest version of file watching</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">FileSystem</span><span class="p">.</span><span class="nx">watch</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This is the latest</span>
      <span class="nx">runtimeJsonWatcher</span> <span class="o">=</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="p">{</span><span class="nx">persistent</span><span class="o">:</span><span class="kc">false</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>

        <span class="c1">// Re-attach watcher on inode change (happens when some editors save a file)</span>
        <span class="c1">// Wait for the O/S rename to complete, then re-watch the file</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span> <span class="o">==</span> <span class="s1">&#39;rename&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">watchForConfigFileChanges</span><span class="p">();</span>
            <span class="nx">onFileChange</span><span class="p">();</span>
          <span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">onFileChange</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Old style polling - only choice if running pre-6.0</span>
      <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">watchFile</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="p">{</span><span class="nx">persistent</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="nx">interval</span><span class="o">:</span><span class="nx">watchInterval</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">curr</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">===</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">mtime</span><span class="p">.</span><span class="nx">getTime</span><span class="p">())</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>
        <span class="nx">onFileChange</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Complain if it exists and we can&#39;t watch it</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">!==</span> <span class="s1">&#39;ENOENT&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error watching for file: &quot;</span> <span class="o">+</span> <span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Return the sources for the configurations</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * All sources for configurations are stored in an array of objects containing</span>
<span class="cm"> * the source name (usually the filaname), the original source (as a string),</span>
<span class="cm"> * and the parsed source as an object.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method getConfigSources</span>
<span class="cm"> * @return configSources {Array[Object]} - An array of objects containing</span>
<span class="cm"> *    name, original, and parsed elements</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getConfigSources</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">configSources</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Watch the specified object for a change in properties, and persist changes</span>
<span class="cm"> * to runtime.json when a change is detected.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @param object {object} - The config object to watch</span>
<span class="cm"> * @method _persistConfigsOnChange</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_persistConfigsOnChange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">objectToWatch</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">PERSIST_ON_CHANGE</span> <span class="o">===</span> <span class="s1">&#39;N&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Watch for configuration value changes</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">objectToWatch</span> <span class="o">=</span> <span class="nx">objectToWatch</span> <span class="o">||</span> <span class="nx">t</span><span class="p">;</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">objectToWatch</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="c1">// Return early if we&#39;re already queued up for persisting</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isQueuedForPersistence</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Defer persisting until the next tick.  This results in a single</span>
    <span class="c1">// persist across any number of config changes in a single event cycle.</span>
    <span class="nx">isQueuedForPersistence</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

      <span class="c1">// Persist if necessary</span>
      <span class="kd">var</span> <span class="nx">newDiffs</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_diffDeep</span><span class="p">(</span><span class="nx">originalConfig</span><span class="p">,</span> <span class="nx">t</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">_equalsDeep</span><span class="p">(</span><span class="nx">newDiffs</span><span class="p">,</span> <span class="nx">runtimeJson</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">newDiffs</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Error writing &quot;</span> <span class="o">+</span> <span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>

      <span class="c1">// Set up for next time</span>
      <span class="nx">isQueuedForPersistence</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Load the individual file configurations.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method builds a map of filename to the configuration object defined</span>
<span class="cm"> * by the file.  The search order is:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   default.EXT</span>
<span class="cm"> *   (hostname).EXT</span>
<span class="cm"> *   (deployment).EXT</span>
<span class="cm"> *   (hostname)-(deployment).EXT</span>
<span class="cm"> *   local.EXT</span>
<span class="cm"> *   local-(deployment).EXT</span>
<span class="cm"> *   runtime.json</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * EXT can be yml, yaml, coffee, json, or js signifying the file type.</span>
<span class="cm"> * yaml (and yml) is in YAML format, coffee is a coffee-script,</span>
<span class="cm"> * json is in JSON format, and js is a javascript executable file that is</span>
<span class="cm"> * require()&#39;d with module.exports being the config object.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * hostname is the $HOST environment variable (or --HOST command line parameter)</span>
<span class="cm"> * if set, otherwise the $HOSTNAME environment variable (or --HOSTNAME command</span>
<span class="cm"> * line parameter) if set, otherwise the hostname found from</span>
<span class="cm"> * require(&#39;os&#39;).hostname().</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * Once a hostname is found, everything from the first period (&#39;.&#39;) onwards</span>
<span class="cm"> * is removed. For example, abc.example.com becomes abc</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * (deployment) is the deployment type, found in the $NODE_ENV environment</span>
<span class="cm"> * variable or --NODE_ENV command line parameter.  Defaults to &#39;development&#39;.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The runtime.json file contains configuration changes made at runtime either</span>
<span class="cm"> * manually, or by the application setting a configuration value.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * If the $NODE_APP_INSTANCE environment variable (or --NODE_APP_INSTANCE</span>
<span class="cm"> * command line parameter) is set, then files with this appendage will be loaded.</span>
<span class="cm"> * See the Multiple Applicstion Instances section of the main documentaion page</span>
<span class="cm"> * for more information.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _loadFileConfigs</span>
<span class="cm"> * @return {this} The configuration object</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_loadFileConfigs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// Initialize</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="c1">// Run only once</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">originalConfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Determine the host name from the OS module, $HOST, or $HOSTNAME</span>
  <span class="c1">// Remove any . appendages, and default to null if not set</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">HOST</span> <span class="o">||</span> <span class="nx">HOSTNAME</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hostName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">OS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
        <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">OS</span><span class="p">.</span><span class="nx">hostname</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hostName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">hostName</span> <span class="o">=</span> <span class="nx">hostName</span> <span class="o">?</span> <span class="nx">hostName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>

  <span class="c1">// Read each file in turn</span>
  <span class="kd">var</span> <span class="nx">baseNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="nx">hostName</span><span class="p">,</span> <span class="nx">NODE_ENV</span><span class="p">,</span> <span class="nx">hostName</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">NODE_ENV</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;local-&#39;</span> <span class="o">+</span> <span class="nx">NODE_ENV</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">extNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;coffee&#39;</span><span class="p">,</span> <span class="s1">&#39;yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;yml&#39;</span><span class="p">];</span>
  <span class="nx">baseNames</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">baseName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">extNames</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">extName</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Try merging the config object into this object</span>
      <span class="kd">var</span> <span class="nx">fullFilename</span> <span class="o">=</span> <span class="nx">CONFIG_DIR</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">baseName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">extName</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">configObj</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_parseFile</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">configObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">configObj</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// See if the application instance file is available</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">APP_INSTANCE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fullFilename</span> <span class="o">=</span> <span class="nx">CONFIG_DIR</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">baseName</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nx">APP_INSTANCE</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">extName</span><span class="p">;</span>
        <span class="nx">configObj</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_parseFile</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">configObj</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">configObj</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="c1">// Override configurations with the old-style environment variables</span>
  <span class="c1">// Warning: This will be deprecated in a future major revision release</span>
  <span class="kd">var</span> <span class="nx">oldStyleEnv</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_loadOldStyleEnv</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">oldStyleEnv</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">oldStyleEnv</span><span class="p">);</span>
    <span class="nx">configSources</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Old-Style Environment Variables&quot;</span><span class="p">,</span>
      <span class="nx">parsed</span><span class="o">:</span> <span class="nx">oldStyleEnv</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;\nWarning - old style $CONFIG_* environment configurations found. Convert to $NODE_CONFIG={JSON}&#39;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// Override configurations from the $NODE_CONFIG environment variable</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_CONFIG</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">newStyleEnv</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">newStyleEnv</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_CONFIG</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;The $NODE_CONFIG environment variable is malformed JSON&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">newStyleEnv</span><span class="p">);</span>
    <span class="nx">configSources</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;$NODE_CONFIG&quot;</span><span class="p">,</span>
      <span class="nx">parsed</span><span class="o">:</span> <span class="nx">newStyleEnv</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Override configurations from the --NODE_CONFIG command line</span>
  <span class="kd">var</span> <span class="nx">cmdLineConfig</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_getCmdLineArg</span><span class="p">(</span><span class="s1">&#39;NODE_CONFIG&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">cmdLineConfig</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">cmdLineConfig</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">cmdLineConfig</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;The --NODE_CONFIG={json} command line argument is malformed JSON&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">cmdLineConfig</span><span class="p">);</span>
    <span class="nx">configSources</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;--NODE_CONFIG argument&quot;</span><span class="p">,</span>
      <span class="nx">parsed</span><span class="o">:</span> <span class="nx">cmdLineConfig</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Remember the original configuration (before adding runtimeJson)</span>
  <span class="nx">originalConfig</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_cloneDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>

  <span class="c1">// Extend the original config with any prior runtime.json diffs</span>
  <span class="nx">runtimeJson</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_parseFile</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">runtimeJson</span><span class="p">);</span>

  <span class="c1">// Attach the config.prototype to all sub-objects.</span>
  <span class="nx">t</span><span class="p">.</span><span class="nx">_attachProtoDeep</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>

  <span class="c1">// Return the configuration object</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Check for the old-style environment variable configurations</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @deprecated</span>
<span class="cm"> * @method _loadOldStyleEnv</span>
<span class="cm"> * @return {Object} old-style configurations from process.env</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_loadOldStyleEnv</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">envOverride</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">varName</span> <span class="k">in</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">varName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;CONFIG_&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Get the string or numeric value</span>
      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">varName</span><span class="p">],</span>
          <span class="nx">floatVal</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="nx">floatVal</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="nx">value</span> <span class="o">?</span> <span class="nx">floatVal</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>

      <span class="c1">// Convert __ to ` (which you can&#39;t have in environment variables)</span>
      <span class="c1">// After splitting, ` are converted to single underscores</span>
      <span class="nx">varName</span> <span class="o">=</span> <span class="nx">varName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/__/g</span><span class="p">,</span><span class="s1">&#39;`&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">varName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>
      <span class="nx">parts</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// remove CONFIG</span>

      <span class="kd">var</span> <span class="nx">curCtxt</span> <span class="o">=</span> <span class="nx">envOverride</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">partName</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/`/g</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Final (element) part</span>
          <span class="nx">curCtxt</span><span class="p">[</span><span class="nx">partName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// Mid (object) part</span>
          <span class="nx">curCtxt</span><span class="p">[</span><span class="nx">partName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curCtxt</span><span class="p">[</span><span class="nx">partName</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
          <span class="nx">curCtxt</span> <span class="o">=</span> <span class="nx">curCtxt</span><span class="p">[</span><span class="nx">partName</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">envOverride</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Parse and return the specified configuration file.</span>
<span class="cm"> *</span>
<span class="cm"> * If the file exists in the application config directory, it will</span>
<span class="cm"> * parse and return it as a JavaScript object.</span>
<span class="cm"> *</span>
<span class="cm"> * The file extension determines the parser to use.</span>
<span class="cm"> *</span>
<span class="cm"> * .js = File to run that has a module.exports containing the config object</span>
<span class="cm"> * .json = File is parsed using JSON.parse()</span>
<span class="cm"> * .coffee = File to run that has a module.exports with coffee-script containing the config object</span>
<span class="cm"> * .yaml (or .yml) = Parsed with a YAML parser</span>
<span class="cm"> *</span>
<span class="cm"> * If the file doesn&#39;t exist, a null will be returned.  If the file can&#39;t be</span>
<span class="cm"> * parsed, an exception will be thrown.</span>
<span class="cm"> *</span>
<span class="cm"> * This method performs synchronous file operations, and should not be called</span>
<span class="cm"> * after synchronous module loading.</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _parseFile</span>
<span class="cm"> * @param fullFilename {string} The full file path and name</span>
<span class="cm"> * @return {configObject} The configuration object parsed from the file</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_parseFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Initialize</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">extension</span> <span class="o">=</span> <span class="nx">fullFilename</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
      <span class="nx">configObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">fileContent</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="c1">// Make sure the runtime.json file exists.  This is required for fs.watch().</span>
  <span class="kd">var</span> <span class="nx">checkRuntimeJson</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fullFilename</span> <span class="o">==</span> <span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If we cannot write file, clear watch function.</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">watchForConfigFileChanges</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">};</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{};</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// Return null if the file doesn&#39;t exist.</span>
  <span class="c1">// Note that all methods here are the Sync versions.  This is appropriate during</span>
  <span class="c1">// module loading (which is a synchronous operation), but not thereafter.</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stat</span> <span class="o">=</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stat</span> <span class="o">||</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">checkRuntimeJson</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">checkRuntimeJson</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Try loading the file.</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">fileContent</span> <span class="o">=</span> <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">,</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Config file &#39;</span> <span class="o">+</span> <span class="nx">fullFilename</span> <span class="o">+</span> <span class="s1">&#39; cannot be read&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Parse the file based on extension</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;yaml&#39;</span> <span class="o">||</span> <span class="nx">extension</span> <span class="o">===</span> <span class="s1">&#39;yml&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Yaml</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">VisionmediaYaml</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Lazy loading</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="c1">// Try to load the better js-yaml module</span>
          <span class="nx">Yaml</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;js-yaml&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// If it doesn&#39;t exist, load the fallback visionmedia yaml module.</span>
          <span class="nx">VisionmediaYaml</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;yaml&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">Yaml</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">configObject</span> <span class="o">=</span> <span class="nx">Yaml</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_stripYamlComments</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">VisionmediaYaml</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// The yaml library doesn&#39;t like strings that have newlines but don&#39;t</span>
        <span class="c1">// end in a newline: https://github.com/visionmedia/js-yaml/issues/issue/13</span>
        <span class="nx">fileContent</span> <span class="o">+=</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
        <span class="nx">configObject</span> <span class="o">=</span> <span class="nx">VisionmediaYaml</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_stripYamlComments</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;No YAML parser loaded.  Suggest adding js-yaml dependency to your package.json file.&quot;</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Allow comments in JSON files</span>
      <span class="nx">configObject</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_stripComments</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">==</span> <span class="s1">&#39;js&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Use the built-in parser for .js files</span>
      <span class="nx">configObject</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">extension</span> <span class="o">==</span> <span class="s1">&#39;coffee&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Lazy load the coffee-script extension</span>
      <span class="nx">Coffee</span> <span class="o">=</span> <span class="nx">Coffee</span> <span class="o">||</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;coffee-script&#39;</span><span class="p">);</span>
      <span class="c1">// Use the built-in parser for .coffee files with coffee-script</span>
      <span class="nx">configObject</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">fullFilename</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">catch</span> <span class="p">(</span><span class="nx">e3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot parse config file: &#39;&quot;</span> <span class="o">+</span> <span class="nx">fullFilename</span> <span class="o">+</span> <span class="s2">&quot;&#39;: &quot;</span> <span class="o">+</span> <span class="nx">e3</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Keep track of this configuration source if it has anything in it</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">configObject</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">configSources</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="nx">fullFilename</span><span class="p">,</span>
      <span class="nx">original</span><span class="o">:</span> <span class="nx">fileContent</span><span class="p">,</span>
      <span class="nx">parsed</span><span class="o">:</span> <span class="nx">configObject</span><span class="p">,</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">configObject</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Attach the Config class prototype to all config objects recursively.</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This allows you to do anything with CONFIG sub-objects as you can do with</span>
<span class="cm"> * the top-level CONFIG object.  It&#39;s so you can do this:</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;pre&gt;</span>
<span class="cm"> *   var CUST_CONFIG = require(&#39;config&#39;).Customer;</span>
<span class="cm"> *   CUST_CONFIG.watch(...)</span>
<span class="cm"> * &lt;/pre&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _attachProtoDeep</span>
<span class="cm"> * @param toObject</span>
<span class="cm"> * @param depth</span>
<span class="cm"> * @return toObject</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_attachProtoDeep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">toObject</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Recursion detection</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">depth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">DEFAULT_CLONE_DEPTH</span> <span class="o">:</span> <span class="nx">depth</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">toObject</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Adding Config.prototype methods directly to toObject as hidden properties</span>
  <span class="c1">// because adding to toObject.__proto__ exposes the function in toObject</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">fnName</span> <span class="k">in</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">makeHidden</span><span class="p">(</span><span class="nx">toObject</span><span class="p">,</span> <span class="nx">fnName</span><span class="p">,</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">fnName</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="c1">// Cycle through each element</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">toObject</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Call recursively if an object</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">toObject</span><span class="p">[</span><span class="nx">prop</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">_attachProtoDeep</span><span class="p">(</span><span class="nx">toObject</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return the original object</span>
  <span class="k">return</span> <span class="nx">toObject</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Return a deep copy of the specified object.</span>
<span class="cm"> *</span>
<span class="cm"> * This returns a new object with all elements copied from the specified</span>
<span class="cm"> * object.  Deep copies are made of objects and arrays so you can do anything</span>
<span class="cm"> * with the returned object without affecting the input object.</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _cloneDeep</span>
<span class="cm"> * @param copyFrom {object} The original object to copy from</span>
<span class="cm"> * @param depth {integer} An optional depth to prevent recursion.  Default: 20.</span>
<span class="cm"> * @return {object} A new object with the elements copied from the copyFrom object</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_cloneDeep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Recursion detection</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">depth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">DEFAULT_CLONE_DEPTH</span> <span class="o">:</span> <span class="nx">depth</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="c1">// Create the copy of the correct type</span>
  <span class="kd">var</span> <span class="nx">copy</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="p">{};</span>

  <span class="c1">// Cycle through each element</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Call recursively if an object or array</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">copy</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_cloneDeep</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">copy</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return the copied object</span>
  <span class="k">return</span> <span class="nx">copy</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Return true if two objects have equal contents.</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _equalsDeep</span>
<span class="cm"> * @param object1 {object} The object to compare from</span>
<span class="cm"> * @param object2 {object} The object to compare with</span>
<span class="cm"> * @param depth {integer} An optional depth to prevent recursion.  Default: 20.</span>
<span class="cm"> * @return {boolean} True if both objects have equivalent contents</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_equalsDeep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object1</span><span class="p">,</span> <span class="nx">object2</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Recursion detection</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="nx">depth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">DEFAULT_CLONE_DEPTH</span> <span class="o">:</span> <span class="nx">depth</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="c1">// Fast comparisons</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">object1</span> <span class="o">||</span> <span class="o">!</span><span class="nx">object2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">object1</span> <span class="o">===</span> <span class="nx">object2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">object1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">object2</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// They must have the same keys.  If their length isn&#39;t the same</span>
  <span class="c1">// then they&#39;re not equal.  If the keys aren&#39;t the same, the value</span>
  <span class="c1">// comparisons will fail.</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">object1</span><span class="p">).</span><span class="nx">length</span> <span class="o">!=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">object2</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Compare the values</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">object1</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Call recursively if an object or array</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">object1</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">object1</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">_equalsDeep</span><span class="p">(</span><span class="nx">object1</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">object2</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">object1</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">object2</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Test passed.</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Returns an object containing all elements that differ between two objects.</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method was designed to be used to create the runtime.json file</span>
<span class="cm"> * contents, but can be used to get the diffs between any two Javascript objects.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * It works best when object2 originated by deep copying object1, then</span>
<span class="cm"> * changes were made to object2, and you want an object that would give you</span>
<span class="cm"> * the changes made to object1 which resulted in object2.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _diffDeep</span>
<span class="cm"> * @param object1 {object} The base object to compare to</span>
<span class="cm"> * @param object2 {object} The object to compare with</span>
<span class="cm"> * @param depth {integer} An optional depth to prevent recursion.  Default: 20.</span>
<span class="cm"> * @return {object} A differential object, which if extended onto object1 would</span>
<span class="cm"> *                  result in object2.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_diffDeep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object1</span><span class="p">,</span> <span class="nx">object2</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Recursion detection</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">diff</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">depth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">DEFAULT_CLONE_DEPTH</span> <span class="o">:</span> <span class="nx">depth</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{};</span>
  <span class="p">}</span>

  <span class="c1">// Process each element from object2, adding any element that&#39;s different</span>
  <span class="c1">// from object 1.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">parm</span> <span class="k">in</span> <span class="nx">object2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value1</span> <span class="o">=</span> <span class="nx">object1</span><span class="p">[</span><span class="nx">parm</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">value2</span> <span class="o">=</span> <span class="nx">object2</span><span class="p">[</span><span class="nx">parm</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value1</span> <span class="o">&amp;&amp;</span> <span class="nx">value2</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">value2</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_equalsDeep</span><span class="p">(</span><span class="nx">value1</span><span class="p">,</span> <span class="nx">value2</span><span class="p">)))</span> <span class="p">{</span>
        <span class="nx">diff</span><span class="p">[</span><span class="nx">parm</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_diffDeep</span><span class="p">(</span><span class="nx">value1</span><span class="p">,</span> <span class="nx">value2</span><span class="p">,</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">value2</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">_equalsDeep</span><span class="p">(</span><span class="nx">value1</span><span class="p">,</span> <span class="nx">value2</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">diff</span><span class="p">[</span><span class="nx">parm</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value2</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value1</span> <span class="o">!==</span> <span class="nx">value2</span><span class="p">){</span>
      <span class="nx">diff</span><span class="p">[</span><span class="nx">parm</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value2</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// Return the diff object</span>
  <span class="k">return</span> <span class="nx">diff</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Extend an object, and any object it contains.</span>
<span class="cm"> *</span>
<span class="cm"> * This does not replace deep objects, but dives into them</span>
<span class="cm"> * replacing individual elements instead.</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _extendDeep</span>
<span class="cm"> * @param mergeInto {object} The object to merge into</span>
<span class="cm"> * @param mergeFrom... {object...} - Any number of objects to merge from</span>
<span class="cm"> * @param depth {integer} An optional depth to prevent recursion.  Default: 20.</span>
<span class="cm"> * @return {object} The altered mergeInto object is returned</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_extendDeep</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mergeInto</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// Initialize</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">vargs</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">depth</span> <span class="o">=</span> <span class="nx">vargs</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">depth</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">vargs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">depth</span><span class="p">);</span>
    <span class="nx">depth</span> <span class="o">=</span> <span class="nx">DEFAULT_CLONE_DEPTH</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Recursion detection</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">mergeInto</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Cycle through each object to extend</span>
  <span class="nx">vargs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">mergeFrom</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Cycle through each element of the object to merge from</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">mergeFrom</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// Extend recursively if both elements are objects</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">mergeInto</span><span class="p">[</span><span class="nx">prop</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_isObject</span><span class="p">(</span><span class="nx">mergeFrom</span><span class="p">[</span><span class="nx">prop</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">_extendDeep</span><span class="p">(</span><span class="nx">mergeInto</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">mergeFrom</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Copy recursively if the mergeFrom element is an object (or array or fn)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mergeFrom</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">mergeFrom</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mergeInto</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_cloneDeep</span><span class="p">(</span><span class="nx">mergeFrom</span><span class="p">[</span><span class="nx">prop</span><span class="p">],</span> <span class="nx">depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Simple assignment otherwise</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">mergeInto</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mergeFrom</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Chain</span>
  <span class="k">return</span> <span class="nx">mergeInto</span><span class="p">;</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Strip YAML comments from the string</span>
<span class="cm"> *</span>
<span class="cm"> * The 2.0 yaml parser doesn&#39;t allow comment-only or blank lines.  Strip them.</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _stripYamlComments</span>
<span class="cm"> * @param fileString {string} The string to strip comments from</span>
<span class="cm"> * @return {string} The string with comments stripped.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_stripYamlComments</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileStr</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// First replace removes comment-only lines</span>
  <span class="c1">// Second replace removes blank lines</span>
  <span class="k">return</span> <span class="nx">fileStr</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s*#.*/mg</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s*[\n|\r]+/mg</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Strip all Javascript type comments from the string.</span>
<span class="cm"> *</span>
<span class="cm"> * The string is usually a file loaded from the O/S, containing</span>
<span class="cm"> * newlines and javascript type comments.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to James Padolsey, and all who conributed to this implementation.</span>
<span class="cm"> * http://james.padolsey.com/javascript/javascript-comment-removal-revisted/</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _stripComments</span>
<span class="cm"> * @param fileString {string} The string to strip comments from</span>
<span class="cm"> * @return {string} The string with comments stripped.</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_stripComments</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fileStr</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">uid</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="nx">primitives</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">primIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="nx">fileStr</span>

    <span class="cm">/* Remove strings */</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([&#39;&quot;])(\\\1|.)+?\1/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">){</span>
      <span class="nx">primitives</span><span class="p">[</span><span class="nx">primIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">uid</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">primIndex</span><span class="o">++</span><span class="p">;</span>
    <span class="p">})</span>

    <span class="cm">/* Remove Regexes */</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/([^\/])(\/(?!\*|\/)(\\\/|.)+?\/[gim]{0,3})/g</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">$1</span><span class="p">,</span> <span class="nx">$2</span><span class="p">){</span>
      <span class="nx">primitives</span><span class="p">[</span><span class="nx">primIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$2</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">$1</span> <span class="o">+</span> <span class="p">(</span><span class="nx">uid</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">primIndex</span><span class="o">++</span><span class="p">;</span>
    <span class="p">})</span>

    <span class="cm">/*</span>
<span class="cm">    - Remove single-line comments that contain would-be multi-line delimiters</span>
<span class="cm">        E.g. // Comment /* &lt;--</span>
<span class="cm">    - Remove multi-line comments that contain would be single-line delimiters</span>
<span class="cm">        E.g. /* // &lt;--</span>
<span class="cm">   */</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/\/.*?\/?\*.+?(?=\n|\r|$)|\/\*[\s\S]*?\/\/[\s\S]*?\*\//g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="cm">/*</span>
<span class="cm">    Remove single and multi-line comments,</span>
<span class="cm">    no consideration of inner-contents</span>
<span class="cm">   */</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/\/.+?(?=\n|\r|$)|\/\*[\s\S]+?\*\//g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="cm">/*</span>
<span class="cm">    Remove multi-line comments that have a replaced ending (string/regex)</span>
<span class="cm">    Greedy, so no inner strings/regexes will stop it.</span>
<span class="cm">   */</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;\\/\\*[\\s\\S]+&#39;</span> <span class="o">+</span> <span class="nx">uid</span> <span class="o">+</span> <span class="s1">&#39;\\d+&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="cm">/* Bring back strings &amp; regexes */</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">(</span><span class="nx">uid</span> <span class="o">+</span> <span class="s1">&#39;(\\d+)&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">n</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">primitives</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
    <span class="p">})</span>
  <span class="p">);</span>

<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Is the specified argument a regular javascript object?</span>
<span class="cm"> *</span>
<span class="cm"> * The argument is an object if it&#39;s a JS object, but not an array.</span>
<span class="cm"> *</span>
<span class="cm"> * @protected</span>
<span class="cm"> * @method _isObject</span>
<span class="cm"> * @param arg {MIXED} An argument of any type.</span>
<span class="cm"> * @return {boolean} TRUE if the arg is an object, FALSE if not</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_isObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">obj</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Exposing original Config&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method allows get the original config properties.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method getOriginalConfig</span>
<span class="cm"> * @return {object} The original config object is returned</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getOriginalConfig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">originalConfig</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Reset Runtime Config&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method allows you to reset the runtime.json generated file.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method resetRuntime</span>
<span class="cm"> * @param callback {function} An optional callback function</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resetRuntime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">FileSystem</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">RUNTIME_JSON_FILENAME</span><span class="p">,</span> <span class="s1">&#39;{}&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Cannot write runtime.json file &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Write to runtime.json completed&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">buffer</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Initialize a parameter from the command line or process environment&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method looks for the parameter from the command line in the format</span>
<span class="cm"> * --PARAMETER=VALUE, then from the process environment, then from the</span>
<span class="cm"> * default specified as an argument.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method _initParam</span>
<span class="cm"> * @param paramName {String} Name of the parameter</span>
<span class="cm"> * @param [defaultValue] {Any} Default value of the parameter</span>
<span class="cm"> * @return {Any} The found value, or default value</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_initParam</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">paramName</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">_getCmdLineArg</span><span class="p">(</span><span class="nx">paramName</span><span class="p">)</span> <span class="o">||</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">paramName</span><span class="p">]</span> <span class="o">||</span> <span class="nx">defaultValue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * &lt;p&gt;Get Command Line Arguments&lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * This method allows you to retrieve the value of the specified command line argument.</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &lt;p&gt;</span>
<span class="cm"> * The argument is case sensitive, and must be of the form &#39;--ARG_NAME=value&#39;</span>
<span class="cm"> * &lt;/p&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * @method _getCmdLineArg</span>
<span class="cm"> * @param searchFor {STRING} The argument name to search for</span>
<span class="cm"> * @return {MIXED} FALSE if the argument was not found, the argument value if found</span>
<span class="cm"> */</span>
<span class="nx">Config</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getCmdLineArg</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">searchFor</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cmdLineArgs</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
        <span class="nx">argName</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span> <span class="o">+</span> <span class="nx">searchFor</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">argvIt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">argvIt</span> <span class="o">&lt;</span> <span class="nx">cmdLineArgs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">argvIt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cmdLineArgs</span><span class="p">[</span><span class="nx">argvIt</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">argName</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">cmdLineArgs</span><span class="p">[</span><span class="nx">argvIt</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="nx">argName</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Assure the configuration object is a singleton.</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">NODE_CONFIG</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">NODE_CONFIG</span> <span class="o">?</span> <span class="nx">global</span><span class="p">.</span><span class="nx">NODE_CONFIG</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">Config</span><span class="p">();</span>

<span class="c1">// The module exports a singleton instance of the Config class so the</span>
<span class="c1">// instance is immediately available on require(), and the prototype methods</span>
<span class="c1">// aren&#39;t a part of the object namespace when inspected.</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nx">NODE_CONFIG</span><span class="p">;</span>

<span class="c1">// Watch for configuration file changes</span>
<span class="nx">global</span><span class="p">.</span><span class="nx">NODE_CONFIG</span><span class="p">.</span><span class="nx">watchForConfigFileChanges</span><span class="p">();</span>
</pre></div>
                    </div>
			</div>
		</div>
		<div class="yui-b">
            <div class="nav">

                    <div id="moduleList" class="module">
                        <h4>Modules</h4>
                        <ul class="content">
                                <li class="selected"><a href="module_config.html" title="config">config</a></li>
                                <li class=""><a href="module_test.html" title="test">test</a></li>
                        </ul>
                    </div>

                    <div id="classList" class="module">
                        <h4>Classes</h4>
                        <ul class="content">
                                <li class=""><a href="Config.html" title="Config">Config</a></li>
                        </ul>
                    </div>

                    <div id="fileList" class="module">
                        <h4>Files</h4>
                        <ul class="content">        
                                <li class="selected"><a href="config.js.html" title="config.js">config.js</a></li>
                        </ul>
                    </div>





            </div>
		</div>
	</div>
	<div id="ft">
        <hr />
Released on <a href="https://github.com/lorenwest/node-config">github</a> under the <a href="https://github.com/lorenwest/node-config/blob/master/LICENSE">Apache License 2.0</a>
<span class="subtitle">version 0.4.32</span>
	</div>
</div>
<script type="text/javascript">
    ALL_YUI_PROPS = [{"url": "Config.html#method__attachProtoDeep", "access": "protected", "host": "Config", "type": "method", "name": "_attachProtoDeep"}, {"url": "Config.html#method__cloneDeep", "access": "protected", "host": "Config", "type": "method", "name": "_cloneDeep"}, {"url": "Config.html#method_constructor", "access": "", "host": "Config", "type": "method", "name": "constructor"}, {"url": "Config.html#method__diffDeep", "access": "protected", "host": "Config", "type": "method", "name": "_diffDeep"}, {"url": "Config.html#method__equalsDeep", "access": "protected", "host": "Config", "type": "method", "name": "_equalsDeep"}, {"url": "Config.html#method__extendDeep", "access": "protected", "host": "Config", "type": "method", "name": "_extendDeep"}, {"url": "Config.html#method__getCmdLineArg", "access": "", "host": "Config", "type": "method", "name": "_getCmdLineArg"}, {"url": "Config.html#method_getConfigSources", "access": "", "host": "Config", "type": "method", "name": "getConfigSources"}, {"url": "Config.html#method_getOriginalConfig", "access": "", "host": "Config", "type": "method", "name": "getOriginalConfig"}, {"url": "Config.html#method__initParam", "access": "", "host": "Config", "type": "method", "name": "_initParam"}, {"url": "Config.html#method__isObject", "access": "protected", "host": "Config", "type": "method", "name": "_isObject"}, {"url": "Config.html#method__loadFileConfigs", "access": "protected", "host": "Config", "type": "method", "name": "_loadFileConfigs"}, {"url": "Config.html#method__loadOldStyleEnv", "access": "protected", "host": "Config", "type": "method", "name": "_loadOldStyleEnv"}, {"url": "Config.html#method_makeHidden", "access": "", "host": "Config", "type": "method", "name": "makeHidden"}, {"url": "Config.html#method_makeImmutable", "access": "", "host": "Config", "type": "method", "name": "makeImmutable"}, {"url": "Config.html#method__parseFile", "access": "protected", "host": "Config", "type": "method", "name": "_parseFile"}, {"url": "Config.html#method__persistConfigsOnChange", "access": "protected", "host": "Config", "type": "method", "name": "_persistConfigsOnChange"}, {"url": "Config.html#method_resetRuntime", "access": "", "host": "Config", "type": "method", "name": "resetRuntime"}, {"url": "Config.html#method_setModuleDefaults", "access": "", "host": "Config", "type": "method", "name": "setModuleDefaults"}, {"url": "Config.html#method__stripComments", "access": "protected", "host": "Config", "type": "method", "name": "_stripComments"}, {"url": "Config.html#method__stripYamlComments", "access": "protected", "host": "Config", "type": "method", "name": "_stripYamlComments"}, {"url": "Config.html#method_watch", "access": "", "host": "Config", "type": "method", "name": "watch"}, {"url": "Config.html#method_watchForConfigFileChanges", "access": "", "host": "Config", "type": "method", "name": "watchForConfigFileChanges"}];
</script>
</body>
</html>
